<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<link rel='stylesheet' type='text/css' href='style.css'>
<script src="script.js" type="text/javascript"></script>

<head>
	<meta http-equiv="content-type" content="text/html; charset=windows-cp1251" />
	<title>
		Коммандировки
	</title>
</head>
<body>

<?php
//----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ini_set("max_execution_time", 0);

function trIt($str) 
{
    $tr = array(
        "А"=>"A","Б"=>"B","В"=>"V","Г"=>"G",
        "Д"=>"D","Е"=>"E","Ж"=>"J","З"=>"Z","И"=>"I",
        "Й"=>"Y","К"=>"K","Л"=>"L","М"=>"M","Н"=>"N",
        "О"=>"O","П"=>"P","Р"=>"R","С"=>"S","Т"=>"T",
        "У"=>"U","Ф"=>"F","Х"=>"H","Ц"=>"Ts","Ч"=>"Ch",
        "Ш"=>"Sh","Щ"=>"Sch","Ъ"=>"","Ы"=>"Yi","Ь"=>"",
        "Э"=>"E","Ю"=>"Yu","Я"=>"Ya","а"=>"a","б"=>"b",
        "в"=>"v","г"=>"g","д"=>"d","е"=>"e","ж"=>"j",
        "з"=>"z","и"=>"i","й"=>"y","к"=>"k","л"=>"l",
        "м"=>"m","н"=>"n","о"=>"o","п"=>"p","р"=>"r",
        "с"=>"s","т"=>"t","у"=>"u","ф"=>"f","х"=>"h",
        "ц"=>"ts","ч"=>"ch","ш"=>"sh","щ"=>"sch","ъ"=>"y",
        "ы"=>"yi","ь"=>"","э"=>"e","ю"=>"yu","я"=>"ya"
    );
    return strtr($str,$tr);}

$dbconn=mssql_connect("sql01-gtptmn","command","jlv8ykxred"); //---подключение к базе
include_once('PHPExcel.php');
set_include_path(get_include_path() . PATH_SEPARATOR . '.');
include 'PHPExcel/IOFactory.php';
//date_default_timezone_set('Europe/London');

//----------------------------------------
$insrt=1;
//----------------------------------------


$inputFileName = './1.xls';
$inputFileType = 'Excel5';
//	$inputFileType = 'Excel2007';
//	$inputFileType = 'Excel2003XML';
//	$inputFileType = 'OOCalc';
//	$inputFileType = 'Gnumeric';

class MyReadFilter implements PHPExcel_Reader_IReadFilter
{
	public function readCell($column, $row, $worksheetName = '') {
		// Read rows 1 to 7 and columns A to E only
		if ($row > 4) {
			if (in_array($column,range('A','Q'))) {
				return true;}}
		return false;}}

$filterSubset = new MyReadFilter();

pathinfo($inputFileName,PATHINFO_BASENAME);
$objReader = PHPExcel_IOFactory::createReader($inputFileType);
echo 'Loading "',$inputFileName,'" <br><br>';
//$objReader->setLoadSheetsOnly($sheetname);
$objReader->setReadFilter($filterSubset);
//$objReader->setInputEncoding('CP1251');
$objPHPExcel = $objReader->load($inputFileName);

$sheetData = $objPHPExcel->getActiveSheet()->toArray(null,true,true,true);

for ($i=5; $i < sizeof($sheetData); $i++) {
	$sheetData[$i]['A']=iconv('UTF-8','CP1251',$sheetData[$i]['A']);
	$sheetData[$i]['B']=iconv('UTF-8','CP1251',$sheetData[$i]['B']);
	$sheetData[$i]['D']=iconv('UTF-8','CP1251',$sheetData[$i]['D']);
	$sheetData[$i]['E']=iconv('UTF-8','CP1251',$sheetData[$i]['E']);
	$sheetData[$i]['F']=iconv('UTF-8','CP1251',$sheetData[$i]['F']); 
	$sheetData[$i]['G']=iconv('UTF-8','CP1251',$sheetData[$i]['G']); $sheetData[$i]['G']=date('d.m.Y',strtotime(substr($sheetData[$i]['F'],6,2)."-".substr($sheetData[$i]['F'],0,2)."-".substr($sheetData[$i]['F'],3,2)))." ".$sheetData[$i]['G']. ":00";
	$sheetData[$i]['J']=iconv('UTF-8','CP1251',$sheetData[$i]['J']); $sheetData[$i]['J']=date('d.m.Y',strtotime(substr($sheetData[$i]['F'],6,2)."-".substr($sheetData[$i]['F'],0,2)."-".substr($sheetData[$i]['F'],3,2)))." ".$sheetData[$i]['J']. ":00";
	$sheetData[$i]['K']=iconv('UTF-8','CP1251',$sheetData[$i]['K']); //$sheetData[$i]['K']=date('d.m.Y',strtotime(substr($sheetData[$i]['F'],6,2)."-".substr($sheetData[$i]['F'],0,2)."-".substr($sheetData[$i]['F'],3,2)))." ".$sheetData[$i]['K']. ":00";
	$sheetData[$i]['M']=iconv('UTF-8','CP1251',$sheetData[$i]['M']); $sheetData[$i]['M']=date('d.m.Y',strtotime(substr($sheetData[$i]['F'],6,2)."-".substr($sheetData[$i]['F'],0,2)."-".substr($sheetData[$i]['F'],3,2)))." ".$sheetData[$i]['M']. ":00";
	$sheetData[$i]['P']=iconv('UTF-8','CP1251',$sheetData[$i]['P']);
	$sheetData[$i]['Q']=iconv('UTF-8','CP1251',$sheetData[$i]['Q']);
} //--- Конвертирование входных данных (кодировка)

echo "<table>";
$in_work_date = date('d.m.Y',strtotime(substr($sheetData[$i]['F'],6,2)."-".substr($sheetData[$i]['F'],0,2)."-".substr($sheetData[$i]['F'],3,2)))." 00:00:00";
for ($i=5; $i < sizeof($sheetData); $i++) {
	if (($sheetData[$i]['E'] == "Тюменьгипротрубопровод" or $sheetData[$i]['E'] == "Временный пропуск") and $sheetData[$i]['D'] != "Рабочие") {
		if ((((substr_count($sheetData[$i]['P'],"Нет") == 0) and (substr_count($sheetData[$i]['Q'],"Нет") == 0)) or ((substr_count($sheetData[$i]['P'],"Нет") != 0)  and (substr_count($sheetData[$i]['Q'],"Нет") == 0)) or ((substr_count($sheetData[$i]['P'],"Нет") == 0)  and (substr_count($sheetData[$i]['Q'],"Нет") != 0)))
		and (((substr_count($sheetData[$i]['P'],"-") == 0)   and (substr_count($sheetData[$i]['Q'],"-") == 0))   or ((substr_count($sheetData[$i]['P'],"-") != 0)    and (substr_count($sheetData[$i]['Q'],"-") == 0))   or ((substr_count($sheetData[$i]['P'],"-") == 0)    and (substr_count($sheetData[$i]['Q'],"-") != 0)))) {
			$query = "SELECT Workers.ID_Worker FROM Workers WHERE (Workers.F_Worker LIKE '%".substr($sheetData[$i]['A'],0,strpos($sheetData[$i]['A']," "))."%') AND (Workers.N_Worker LIKE '%".substr($sheetData[$i]['A'],strpos($sheetData[$i]['A']," ")+1,strrpos($sheetData[$i]['A']," ")-strpos($sheetData[$i]['A']," ")-1)."%') AND (Workers.P_Worker LIKE '%".substr($sheetData[$i]['A'],strrpos($sheetData[$i]['A']," ")+1)."%');";
			$r=mssql_fetch_row(mssql_query($query));
			if (!$r[0]) {
				$query = "SELECT ID_Post FROM Posts WHERE (N_Post LIKE '%".substr($sheetData[$i]['B'],0,9)."%')";
				$r_dol=mssql_fetch_row(mssql_query($query));
				if ($r_dol[0]!= NULL) {
					$query = "SELECT ID_Otdel FROM Otdels WHERE (Name_Otdel LIKE '%".substr($sheetData[$i]['D'],2,9)."%')";
					$r_otdel=mssql_fetch_row(mssql_query($query));
					if ($r_otdel[0] != NULL) {
						$query = "INSERT INTO Workers (F_Worker, N_Worker, P_Worker, I_Worker, ID_Post, ID_Otdel, Login) VALUES ('"
							.substr($sheetData[$i]['A'],0,strpos($sheetData[$i]['A']," "))."','"
							.substr($sheetData[$i]['A'],strpos($sheetData[$i]['A']," ")+1,strrpos($sheetData[$i]['A']," ")-strpos($sheetData[$i]['A']," ")-1)."','"
							.substr($sheetData[$i]['A'],strrpos($sheetData[$i]['A']," ")+1)."','"
							.substr($sheetData[$i]['A'],strpos($sheetData[$i]['A']," ")+1,1).".".substr($sheetData[$i]['A'],strrpos($sheetData[$i]['A']," ")+1,1).".','"
							.$r_dol[0]."','"
							.$r_otdel[0]."','"
							.trIt(substr($sheetData[$i]['A'],0,strpos($sheetData[$i]['A']," "))).trIt(substr($sheetData[$i]['A'],strpos($sheetData[$i]['A']," ")+1,1)).trIt(substr($sheetData[$i]['A'],strrpos($sheetData[$i]['A']," ")+1,1))."');";
						if ($insrt == 1) {
							mssql_query($query);
						} //--- Если пользователь отдел и должность существуют в базах, добавляем нового пользователя
					echo "<br>",$query,"<br>";
					} //--- Проверяем отдел пользователя на наличие в базе отделов
				} //--- Проверяем должность пользователя на наличие в базе должностей
			} //--- Проверяем, есть ли в пользователь в базе пользователей
			$in_work_time_minutes = ((strtotime($sheetData[$i]['G']) - strtotime($in_work_date)) - (strtotime($sheetData[$i]['M']) - strtotime($in_work_date))) / 60;
			if (substr_count($sheetData[$i]['P'],"Нет") or substr_count($sheetData[$i]['P'],"-")) $sheetData[$i]['P']=date('m.d.Y',strtotime(substr($sheetData[$i]['F'],6,2)."-".substr($sheetData[$i]['F'],0,2)."-".substr($sheetData[$i]['F'],3,2)))." 09:00:00";
				else $sheetData[$i]['P']=date('m.d.Y',strtotime(substr($sheetData[$i]['F'],6,2)."-".substr($sheetData[$i]['F'],0,2)."-".substr($sheetData[$i]['F'],3,2)))." ".$sheetData[$i]['P']. ":00";
			if (substr_count($sheetData[$i]['Q'],"Нет") or substr_count($sheetData[$i]['Q'],"-")) $sheetData[$i]['Q']=date('m.d.Y',strtotime(substr($sheetData[$i]['F'],6,2)."-".substr($sheetData[$i]['F'],0,2)."-".substr($sheetData[$i]['F'],3,2)))." 18:15:00";
				else $sheetData[$i]['Q']=date('m.d.Y',strtotime(substr($sheetData[$i]['F'],6,2)."-".substr($sheetData[$i]['F'],0,2)."-".substr($sheetData[$i]['F'],3,2)))." ".$sheetData[$i]['Q']. ":00";
			if (!$r[0]) {
				$query = "SELECT Workers.ID_Worker FROM Workers WHERE (Workers.F_Worker LIKE '%".substr($sheetData[$i]['A'],0,strpos($sheetData[$i]['A']," "))."%') AND (Workers.N_Worker LIKE '%".substr($sheetData[$i]['A'],strpos($sheetData[$i]['A']," ")+1,strrpos($sheetData[$i]['A']," ")-strpos($sheetData[$i]['A']," ")-1)."%') AND (Workers.P_Worker LIKE '%".substr($sheetData[$i]['A'],strrpos($sheetData[$i]['A']," ")+1)."%');";
				$r=mssql_fetch_row(mssql_query($query));
			} //--- Проверяем, был ли добавлен пользователя в базу как новый
			if ($r[0]) {
				$query = "SELECT ID_Worker FROM tURVData WHERE (ID_worker = ".$r[0].") AND (IN_WORK_DATE = CONVERT(DATETIME,'".date('m.d.Y H:i:s',strtotime($in_work_date))."'))";
				echo "<br>",$sheetData[$i]['A'], " - ", $sheetData[$i]['B'], " - ", $sheetData[$i]['D'], " - ", $in_work_date, " - ", $in_work_time_minutes, "<br>", $query, "<br>";
				if ($r != mssql_fetch_row(mssql_query($query))) {
					$query = "INSERT INTO tURVData (ID_Worker, IN_WORK_DATE, DAY_START, DAY_END, IN_WORK_TIME_MINUTES)
							VALUES     ('".$r[0]."','".date('m.d.Y H:i:s',strtotime($in_work_date))."','".$sheetData[$i]['P']."','".$sheetData[$i]['Q']."','".$in_work_time_minutes."')";
					echo $query, ": ";
					if ($insrt == 1) {
						if (mssql_query($query)) echo "Success<br>"; else echo "error!<br>";
					} else {echo "Debug version<br>";}
				} //--- 
					else echo $sheetData[$i]['A']," allredy in base...<br>";
			} //--- Проверяем, есть ли записи по пользователю в базе от этой даты
				else echo "<br>",$sheetData[$i]['A']," user not in base...<br>";
		} //--- Проверка на наличие данных во "Вход" или "Выход"
	} //--- Проверка на принадлежность к организации
	else echo "<br>",$sheetData[$i]['A']," not in Тюменьгипротрубопровод or Временный пропуск and not Рабочие...<br>";
} //--- Прохождение всех занисей в файле
echo "</table>";

mssql_close($dbconn);
//----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
?>

</body>
</html>